<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Modifying biproporz() • proporz</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Modifying biproporz()">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">proporz</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.5.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/apportionment_scenarios.html">Apportionment scenarios</a></li>
    <li><a class="dropdown-item" href="../articles/modifying_biproporz.html">Modifying biproporz()</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/polettif/proporz/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Modifying biproporz()</h1>
                        <h4 data-toc-skip class="author">Flavio
Poletti</h4>
            
            <h4 data-toc-skip class="date">2025-03-07</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/polettif/proporz/blob/v1.5.2/vignettes/modifying_biproporz.Rmd" class="external-link"><code>vignettes/modifying_biproporz.Rmd</code></a></small>
      <div class="d-none name"><code>modifying_biproporz.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">1) Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette demonstrates how to modify and extend the default
implementation of biproportional apportionment in
<code><a href="../reference/biproporz.html">biproporz()</a></code>. We cover the following modifications:</p>
<ul>
<li>Applying a quorum to filter seat-eligible parties</li>
<li>Using alternative predefined apportionment methods</li>
<li>Implementing a custom rounding function for the lower
apportionment</li>
<li>Altering the Winner-Take-One (WTO) method to bypass upper
apportionment constraints</li>
</ul>
<p>We’ll begin by creating a custom dataset: a matrix containing vote
counts and a vector representing the number of seats per district.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://polettif.github.io/proporz/">proporz</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define a custom dataset for this vignette</span></span>
<span><span class="va">votes_matrix</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">800</span>, <span class="fl">2802</span>, <span class="fl">4095</span>,  <span class="fl">0</span>, <span class="fl">150</span>,</span>
<span>     <span class="fl">3900</span>,  <span class="fl">814</span>, <span class="fl">3990</span>, <span class="fl">20</span>,  <span class="fl">60</span>,</span>
<span>     <span class="fl">1400</span>, <span class="fl">1302</span>, <span class="fl">4305</span>, <span class="fl">10</span>,  <span class="fl">80</span>,</span>
<span>     <span class="fl">0</span>,    <span class="fl">0</span>,    <span class="fl">0</span>, <span class="fl">50</span>,   <span class="fl">0</span>,</span>
<span>     <span class="fl">610</span>,  <span class="fl">500</span>, <span class="fl">1001</span>, <span class="fl">40</span>, <span class="fl">120</span><span class="op">)</span>,</span>
<span>  ncol <span class="op">=</span> <span class="fl">5</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    party <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>, <span class="st">"D"</span>, <span class="st">"E"</span><span class="op">)</span>,</span>
<span>    district <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"City 1"</span>, <span class="st">"City 2"</span>, <span class="st">"City 3"</span>, <span class="st">"Region 4"</span>, <span class="st">"Region 5"</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">district_seats</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">14</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">votes_matrix</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="analyzing-the-votes-matrix">Analyzing the Votes Matrix<a class="anchor" aria-label="anchor" href="#analyzing-the-votes-matrix"></a>
</h3>
<p>In our example <code>votes_matrix</code>, each voter casts as many
votes as there are seats in the district. To understand the party
strength across districts, we calculate the number of <em>voters</em>
per party and district by weighting the votes matrix with
<code><a href="../reference/weight_votes_matrix.html">weight_votes_matrix()</a></code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">votes_matrix</span></span>
<span><span class="co">#&gt;      district</span></span>
<span><span class="co">#&gt; party City 1 City 2 City 3 Region 4 Region 5</span></span>
<span><span class="co">#&gt;     A    800   2802   4095        0      150</span></span>
<span><span class="co">#&gt;     B   3900    814   3990       20       60</span></span>
<span><span class="co">#&gt;     C   1400   1302   4305       10       80</span></span>
<span><span class="co">#&gt;     D      0      0      0       50        0</span></span>
<span><span class="co">#&gt;     E    610    500   1001       40      120</span></span>
<span></span>
<span><span class="op">(</span><span class="va">voters</span> <span class="op">=</span> <span class="fu"><a href="../reference/weight_votes_matrix.html">weight_votes_matrix</a></span><span class="op">(</span><span class="va">votes_matrix</span>, <span class="va">district_seats</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;      district</span></span>
<span><span class="co">#&gt; party City 1 City 2 City 3 Region 4 Region 5</span></span>
<span><span class="co">#&gt;     A    160  560.4  292.5        0      150</span></span>
<span><span class="co">#&gt;     B    780  162.8  285.0       20       60</span></span>
<span><span class="co">#&gt;     C    280  260.4  307.5       10       80</span></span>
<span><span class="co">#&gt;     D      0    0.0    0.0       50        0</span></span>
<span><span class="co">#&gt;     E    122  100.0   71.5       40      120</span></span></code></pre></div>
<p>This step is performed within <code><a href="../reference/biproporz.html">biproporz()</a></code> with the
parameter <code>weight_votes = TRUE</code>. The result is a matrix with
fractional voter counts, as votes can be split between multiple
parties.</p>
</div>
</div>
<div class="section level2">
<h2 id="standard-biproportional-apportionment">2) Standard Biproportional Apportionment<a class="anchor" aria-label="anchor" href="#standard-biproportional-apportionment"></a>
</h2>
<p>The default <code><a href="../reference/biproporz.html">biproporz()</a></code> method allocates seats based on
the votes matrix and district seats using standard rounding for both the
upper and lower apportionments.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seats_biproporz_standard</span> <span class="op">=</span> <span class="fu"><a href="../reference/biproporz.html">biproporz</a></span><span class="op">(</span><span class="va">votes_matrix</span>, <span class="va">district_seats</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Number of seats per party</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">seats_biproporz_standard</span><span class="op">)</span></span>
<span><span class="co">#&gt; A B C D E </span></span>
<span><span class="co">#&gt; 8 9 6 0 3</span></span></code></pre></div>
<p>Key observations from the standard apportionment:</p>
<ul>
<li>
<em>Party D</em> did not receive enough votes across all districts
to win a seat.</li>
<li>In <em>City 3</em>, <em>Party B</em> receives the most seats despite
having fewer total votes than two other parties.</li>
<li>
<em>Party E</em>’s strongest district is <em>City 1</em> (122
voters), but it does not win a seat there.</li>
</ul>
<p>The <code><a href="../reference/biproporz.html">biproporz()</a></code> function returns the seat allocation as
a matrix with divisors as hidden attributes (see
<code><a href="../reference/get_divisors.html">get_divisors()</a></code>). You can print the marginal sums (total
seats per party and district) and divisors with
<code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">seats_biproporz_standard</span><span class="op">)</span></span>
<span><span class="co">#&gt;            City 1 City 2 City 3 Region 4 Region 5 (sum) (divisor)</span></span>
<span><span class="co">#&gt;          A      1      2      4        0        1     8      0.91</span></span>
<span><span class="co">#&gt;          B      3      1      5        0        0     9       0.8</span></span>
<span><span class="co">#&gt;          C      1      1      4        0        0     6         1</span></span>
<span><span class="co">#&gt;          D      0      0      0        0        0     0         1</span></span>
<span><span class="co">#&gt;          E      0      1      1        1        0     3      0.76</span></span>
<span><span class="co">#&gt;      (sum)      5      5     14        1        1    26          </span></span>
<span><span class="co">#&gt;  (divisor)   1703   1286   1008      101      324</span></span>
<span></span>
<span><span class="co"># You can transpose the matrix</span></span>
<span><span class="co"># summary(t(seats_biproporz_standard))</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="modifying-biproporz-with-parameters">3) Modifying biproporz with Parameters<a class="anchor" aria-label="anchor" href="#modifying-biproporz-with-parameters"></a>
</h2>
<div class="section level3">
<h3 id="applying-a-quorum">Applying a Quorum<a class="anchor" aria-label="anchor" href="#applying-a-quorum"></a>
</h3>
<p>A quorum can ensure that only parties with a minimum percentage or
number of votes are eligible for seat allocation. In this example, we
impose a 5% quorum on the total votes.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/biproporz.html">biproporz</a></span><span class="op">(</span><span class="va">votes_matrix</span>, <span class="va">district_seats</span>, <span class="fu"><a href="../reference/quorum_functions.html">quorum_any</a></span><span class="op">(</span>total <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;      district</span></span>
<span><span class="co">#&gt; party City 1 City 2 City 3 Region 4 Region 5</span></span>
<span><span class="co">#&gt;     A      1      2      4        0        1</span></span>
<span><span class="co">#&gt;     B      3      1      5        0        0</span></span>
<span><span class="co">#&gt;     C      1      1      4        0        0</span></span>
<span><span class="co">#&gt;     D      0      0      0        0        0</span></span>
<span><span class="co">#&gt;     E      0      1      1        1        0</span></span></code></pre></div>
<p>This does not actually change the seat distribution compared to the
standard method, as <em>Party D</em> is already below the “natural
quorum” and did not get enough votes for any seat.</p>
</div>
<div class="section level3">
<h3 id="alternative-apportionment-methods">Alternative Apportionment Methods<a class="anchor" aria-label="anchor" href="#alternative-apportionment-methods"></a>
</h3>
<p><code><a href="../reference/biproporz.html">biproporz()</a></code> allows you to specify different methods for
the upper and lower apportionment by passing a list to the
<code>method</code> parameter. For example, we can use the Adams method
for the upper apportionment and standard rounding for the lower
apportionment.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/biproporz.html">biproporz</a></span><span class="op">(</span><span class="va">votes_matrix</span>, <span class="va">district_seats</span>, method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"adams"</span>, <span class="st">"round"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;      district</span></span>
<span><span class="co">#&gt; party City 1 City 2 City 3 Region 4 Region 5</span></span>
<span><span class="co">#&gt;     A      1      2      5        0        0</span></span>
<span><span class="co">#&gt;     B      3      1      4        0        0</span></span>
<span><span class="co">#&gt;     C      1      1      4        0        0</span></span>
<span><span class="co">#&gt;     D      0      0      0        1        0</span></span>
<span><span class="co">#&gt;     E      0      1      1        0        1</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="custom-rounding-function">Custom Rounding Function<a class="anchor" aria-label="anchor" href="#custom-rounding-function"></a>
</h3>
<p>To customize seat allocation, you can define your own rounding
function for the lower apportionment. Here’s a custom rounding function
that works as follows:</p>
<ul>
<li>Values below 0.7 are rounded down to 0</li>
<li>Values equal to or greater than 0.7 are rounded up to 1</li>
<li>Standard rounding applies for values greater than 1 (i.e. values
below .5 are rounded down)</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom_rounding_func</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">lt0.7</span> <span class="op">=</span> <span class="va">x</span> <span class="op">&lt;</span> <span class="fl">0.7</span></span>
<span>  <span class="va">x</span><span class="op">[</span><span class="va">lt0.7</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">x</span><span class="op">[</span><span class="op">!</span><span class="va">lt0.7</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ceil_at.html">ceil_at</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="op">!</span><span class="va">lt0.7</span><span class="op">]</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="va">x</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># The function must work with a matrix</span></span>
<span><span class="fu">custom_rounding_func</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">1.5</span>, <span class="fl">2.5</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2]</span></span>
<span><span class="co">#&gt; [1,]    0    2</span></span>
<span><span class="co">#&gt; [2,]    0    3</span></span>
<span></span>
<span><span class="co"># Apply custom rounding function in lower apportionment</span></span>
<span><span class="fu"><a href="../reference/biproporz.html">biproporz</a></span><span class="op">(</span><span class="va">votes_matrix</span>, <span class="va">district_seats</span>, </span>
<span>          method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"adams"</span>, <span class="va">custom_rounding_func</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;      district</span></span>
<span><span class="co">#&gt; party City 1 City 2 City 3 Region 4 Region 5</span></span>
<span><span class="co">#&gt;     A      0      3      5        0        0</span></span>
<span><span class="co">#&gt;     B      3      1      4        0        0</span></span>
<span><span class="co">#&gt;     C      1      1      4        0        0</span></span>
<span><span class="co">#&gt;     D      0      0      0        1        0</span></span>
<span><span class="co">#&gt;     E      1      0      1        0        1</span></span></code></pre></div>
<p>Compared to using standard rounding, parties <em>A</em> and
<em>E</em> swap one seat in cities <em>1</em> and <em>2</em>.</p>
</div>
</div>
<div class="section level2">
<h2 id="district-winner-methods">4) District Winner Methods<a class="anchor" aria-label="anchor" href="#district-winner-methods"></a>
</h2>
<div class="section level3">
<h3 id="winner-take-one-wto">Winner-Take-One (WTO)<a class="anchor" aria-label="anchor" href="#winner-take-one-wto"></a>
</h3>
<p>The WTO method guarantees that the party with the most votes in each
district will receive at least one seat, given that the party is
eligible for a seat from the upper apportionment. These two constraints
may lead to conflicts and an error, as seen below.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="../reference/biproporz.html">biproporz</a></span><span class="op">(</span><span class="va">votes_matrix</span>, <span class="va">district_seats</span>, method <span class="op">=</span> <span class="st">"wto"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error : Not enough upper apportionment seats to give district winner seats to party: 'D'</span></span></code></pre></div>
<p><em>Party D</em> has the most votes in <em>Region 4</em> and should
get a seat there but there’s no party seat to allocate. To prevent this
case, a quorum is usually applied to ensure that only large enough
parties are eligible for seats.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/biproporz.html">biproporz</a></span><span class="op">(</span><span class="va">votes_matrix</span>, <span class="va">district_seats</span>, method <span class="op">=</span> <span class="st">"wto"</span>,</span>
<span>          quorum <span class="op">=</span> <span class="fu"><a href="../reference/quorum_functions.html">quorum_any</a></span><span class="op">(</span>total <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;      district</span></span>
<span><span class="co">#&gt; party City 1 City 2 City 3 Region 4 Region 5</span></span>
<span><span class="co">#&gt;     A      1      2      4        0        1</span></span>
<span><span class="co">#&gt;     B      3      1      5        0        0</span></span>
<span><span class="co">#&gt;     C      1      1      4        0        0</span></span>
<span><span class="co">#&gt;     D      0      0      0        0        0</span></span>
<span><span class="co">#&gt;     E      0      1      1        1        0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="wto-with-an-alternative-upper-apportionment-method">WTO with an Alternative Upper Apportionment Method<a class="anchor" aria-label="anchor" href="#wto-with-an-alternative-upper-apportionment-method"></a>
</h3>
<p>By switching to the Adams method for the upper apportionment,
<em>Party D</em> gets one seat (as we’ve already seen). This resolves
the conflict, allowing WTO to work in the lower apportionment.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/biproporz.html">biproporz</a></span><span class="op">(</span><span class="va">votes_matrix</span>, <span class="va">district_seats</span>, method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"adams"</span>, <span class="st">"wto"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;      district</span></span>
<span><span class="co">#&gt; party City 1 City 2 City 3 Region 4 Region 5</span></span>
<span><span class="co">#&gt;     A      0      2      5        0        1</span></span>
<span><span class="co">#&gt;     B      3      1      4        0        0</span></span>
<span><span class="co">#&gt;     C      1      1      4        0        0</span></span>
<span><span class="co">#&gt;     D      0      0      0        1        0</span></span>
<span><span class="co">#&gt;     E      1      1      1        0        0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="wto-with-ties">WTO with Ties<a class="anchor" aria-label="anchor" href="#wto-with-ties"></a>
</h3>
<p>If two parties have the same number of votes in a district (and
there’s not enough seats for both), there is no clear district winner
and the WTO condition is not applied in this district.
<code>biproporz</code> issues a warning in this case, as seen in this
example:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">tied_votes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">500</span>, <span class="fl">150</span>, <span class="fl">150</span><span class="op">)</span>, <span class="fl">2</span>, </span>
<span>  dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>party <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, district <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;      district</span></span>
<span><span class="co">#&gt; party    1   2</span></span>
<span><span class="co">#&gt;     X 1000 150</span></span>
<span><span class="co">#&gt;     Y  500 150</span></span>
<span><span class="va">tied_votes_seats</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">tied_votes</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="../reference/biproporz.html">biproporz</a></span><span class="op">(</span><span class="va">tied_votes</span>, <span class="va">tied_votes_seats</span>, method <span class="op">=</span> <span class="st">"wto"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Not enough seats for tied parties with the most votes in: '2'</span></span>
<span><span class="co">#&gt; Winner take one condition is not applied in this district.</span></span>
<span><span class="co">#&gt;      district</span></span>
<span><span class="co">#&gt; party 1 2</span></span>
<span><span class="co">#&gt;     X 1 1</span></span>
<span><span class="co">#&gt;     Y 1 0</span></span></code></pre></div>
<p>When WTO is suspended in district <em>2</em>, tied party <em>Y</em>
gets a seat in district <em>1</em> as this distribution better satisfies
the constraints given by the upper apportionment. To explicitly break
the tie (which might be necessary depending on the actual
specifications) you need to modify the votes matrix by adding a very
small vote amount to the district winner. Here is a workflow to break
ties randomly:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tied_districts</span> <span class="op">=</span> <span class="fu"><a href="../reference/district_winner_matrix.html">district_winner_matrix</a></span><span class="op">(</span><span class="va">tied_votes</span>, <span class="va">tied_votes_seats</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">d</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">tied_votes</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">anyNA</a></span><span class="op">(</span><span class="va">tied_districts</span><span class="op">[</span>,<span class="va">d</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">tied_parties</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tied_districts</span><span class="op">[</span>,<span class="va">d</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># break tie randomly</span></span>
<span>    <span class="va">tiebreak_winner</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tied_parties</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"party"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tiebreak_winner</span><span class="op">)</span>, <span class="st">"wins district"</span>, <span class="va">d</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># assuming the impact of a small vote difference on </span></span>
<span>    <span class="co"># the overall result is negligible</span></span>
<span>    <span class="va">tied_votes</span><span class="op">[</span><span class="va">tiebreak_winner</span>,<span class="va">d</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tied_votes</span><span class="op">[</span><span class="va">tiebreak_winner</span>,<span class="va">d</span><span class="op">]</span><span class="op">+</span><span class="fl">1e-9</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; party Y wins district 2</span></span>
<span></span>
<span><span class="fu"><a href="../reference/biproporz.html">biproporz</a></span><span class="op">(</span><span class="va">tied_votes</span>, <span class="va">tied_votes_seats</span>, method <span class="op">=</span> <span class="st">"wto"</span><span class="op">)</span></span>
<span><span class="co">#&gt;      district</span></span>
<span><span class="co">#&gt; party 1 2</span></span>
<span><span class="co">#&gt;     X 2 0</span></span>
<span><span class="co">#&gt;     Y 0 1</span></span></code></pre></div>
<p>As you can see, party <em>Y</em> now has a seat in district
<em>2</em> as they won the tiebreaker. This means in turn that party
<em>X</em> must get both seats in district <em>1</em>.</p>
</div>
<div class="section level3">
<h3 id="guaranteeing-district-winners-a-seat">Guaranteeing District Winners a Seat<a class="anchor" aria-label="anchor" href="#guaranteeing-district-winners-a-seat"></a>
</h3>
<p>You can modify the WTO method to ensure district winners always get a
seat, even if they don’t meet the upper apportionment criteria. Below is
a custom function that implements this approach. This is a non-standard
approach and the function should be adapted as needed.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">biproporz_absolute_wto</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">votes_matrix</span>, <span class="va">district_seats</span>,</span>
<span>                                  <span class="va">quorum</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">weight_votes</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># 1) Identify unambiguous district winners</span></span>
<span>  <span class="co"># Note: This step could also happen after the quorum has been applied</span></span>
<span>  <span class="co"># (depending on the desired method implementation)</span></span>
<span>  <span class="va">district_winners</span> <span class="op">=</span> <span class="fu"><a href="../reference/district_winner_matrix.html">district_winner_matrix</a></span><span class="op">(</span><span class="va">votes_matrix</span>, <span class="va">district_seats</span><span class="op">)</span></span>
<span>  <span class="va">district_winners</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">district_winners</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span> <span class="co"># Ignore ties</span></span>
<span>  </span>
<span>  <span class="co"># 2) Apply quorum if specified</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">quorum</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">votes_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_quorum.html">apply_quorum</a></span><span class="op">(</span><span class="va">votes_matrix</span>, <span class="va">quorum</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># 3) Assign party seats in upper apportionment</span></span>
<span>  <span class="va">ua</span> <span class="op">=</span> <span class="fu"><a href="../reference/upper_apportionment.html">upper_apportionment</a></span><span class="op">(</span><span class="va">votes_matrix</span>, <span class="va">district_seats</span>, </span>
<span>                           <span class="va">weight_votes</span>, method <span class="op">=</span> <span class="st">"round"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># 4.1) Assign seats to district winners without </span></span>
<span>  <span class="co"># enough upper apportionment seats</span></span>
<span>  <span class="va">seats_without_ua</span> <span class="op">=</span> <span class="va">district_winners</span> <span class="op">*</span> <span class="fl">1L</span></span>
<span>  <span class="va">seats_without_ua</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">district_winners</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="va">ua</span><span class="op">$</span><span class="va">party</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0L</span></span>
<span>  </span>
<span>  <span class="co"># 4.2) Biproportional apportionment for remaining seats</span></span>
<span>  <span class="co"># Build votes matrix, set votes for district winners </span></span>
<span>  <span class="co"># without enough upper apportionment seats to zero</span></span>
<span>  <span class="va">biprop_votes_matrix</span> <span class="op">=</span> <span class="va">votes_matrix</span></span>
<span>  <span class="va">biprop_votes_matrix</span><span class="op">[</span><span class="va">seats_without_ua</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  </span>
<span>  <span class="co"># Reduce the number of seats for districts that </span></span>
<span>  <span class="co"># already had a "insufficient district winner" seat assigned</span></span>
<span>  <span class="va">biprop_district_seats</span> <span class="op">=</span> <span class="va">district_seats</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">seats_without_ua</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Run biproporz</span></span>
<span>  <span class="va">seats_biproporz</span> <span class="op">=</span> <span class="fu"><a href="../reference/biproporz.html">biproporz</a></span><span class="op">(</span><span class="va">biprop_votes_matrix</span>, </span>
<span>                              <span class="va">biprop_district_seats</span>, </span>
<span>                              method <span class="op">=</span> <span class="st">"wto"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Remove divisor attributes, as they're no longer </span></span>
<span>  <span class="co"># meaningful for the combined distribution</span></span>
<span>  <span class="va">seats_biproporz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">seats_biproporz</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># 5) Return final seat distribution,</span></span>
<span>  <span class="co">#    combining the two apportionments </span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">seats_biproporz</span> <span class="op">+</span> <span class="va">seats_without_ua</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let’s compare the standard biproportional apportionment to the
modified method, which guarantees district winners a seat.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seats_biproporz_absolute_wto</span> <span class="op">=</span> <span class="fu">biproporz_absolute_wto</span><span class="op">(</span><span class="va">votes_matrix</span>, </span>
<span>                                                      <span class="va">district_seats</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show the difference to the standard apportionment</span></span>
<span><span class="va">seats_biproporz_absolute_wto</span> <span class="op">-</span> <span class="va">seats_biproporz_standard</span></span>
<span><span class="co">#&gt;      district</span></span>
<span><span class="co">#&gt; party City 1 City 2 City 3 Region 4 Region 5</span></span>
<span><span class="co">#&gt;     A     -1      0      1        0        0</span></span>
<span><span class="co">#&gt;     B      0      0     -1        0        0</span></span>
<span><span class="co">#&gt;     C      0      0      0        0        0</span></span>
<span><span class="co">#&gt;     D      0      0      0        1        0</span></span>
<span><span class="co">#&gt;     E      1      0      0       -1        0</span></span></code></pre></div>
<p>In this example, <em>Party D</em> gains a seat from <em>Party B</em>.
To satisfy the new constraints, there are changes in district seat
distributions for <em>Party A</em> and <em>Party E</em>.</p>
<p>Note that while this method resolves possible conflicts for district
winners without upper apportionment seats, other conflicts might arise.
For example, if too many district winners are missing upper
apportionment seats, the constraints for allocating the remaining seats
may become overly restrictive.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Flavio Poletti.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
